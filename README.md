# âœˆï¸ ZARITA! - Sistema CRM de GestiÃ³n de Prospectos

Bienvenido a **ZARITA!**, un sistema CRM completo diseÃ±ado para optimizar la gestiÃ³n de prospectos y clientes en agencias de viajes. Este sistema permite realizar un seguimiento detallado de cada oportunidad de venta, desde el primer contacto hasta el cierre, facilitando la colaboraciÃ³n entre agentes y supervisores.

---

## ğŸš€ CaracterÃ­sticas Principales

### ğŸ“Š Dashboard Interactivo
- **Vista General en Tiempo Real:** Resumen de prospectos por estado (Nuevos, Seguimiento, Cotizados, Ganados, Perdidos, Ventas Canceladas)
- **KPIs Avanzados:** 
  - ConversiÃ³n por agente con mÃ©tricas de cotizaciones y ventas
  - Destinos mÃ¡s solicitados
  - Prospectos con datos completos vs. incompletos
  - Clientes sin asignar y asignados
- **Filtros Temporales Avanzados:** 
  - Presets rÃ¡pidos: Hoy, Esta Semana, Este Mes, Este AÃ±o
  - Rango de fechas personalizado
  - Persistencia de filtros entre sesiones

### ğŸ‘¥ GestiÃ³n de Prospectos
- **Pipeline de Ventas Completo:** Estados definidos con transiciones controladas
- **AsignaciÃ³n Inteligente de Leads:** 
  - DistribuciÃ³n manual o automÃ¡tica
  - Filtro de prospectos "Nuevos" sin asignar
  - ReasignaciÃ³n con preservaciÃ³n del agente original
- **GestiÃ³n de Clientes Recurrentes:**
  - IdentificaciÃ³n automÃ¡tica de clientes que regresan
  - VinculaciÃ³n con prospecto original
  - Historial completo de compras
- **Datos Completos del Cliente:**
  - InformaciÃ³n de contacto (telÃ©fonos con indicativos internacionales)
  - Detalles del viaje (origen, destino, fechas, pasajeros)
  - InformaciÃ³n adicional para clientes ganados (fecha de nacimiento, identificaciÃ³n, direcciÃ³n)
- **IntegraciÃ³n con WhatsApp:** Enlaces directos para iniciar conversaciones con telÃ©fonos principal y secundario

### ğŸ“ Seguimiento y DocumentaciÃ³n
- **BitÃ¡cora de Interacciones:** 
  - Registro automÃ¡tico de cambios de estado
  - Notas de llamadas, correos y mensajes
  - Historial completo con usuario y fecha
- **GestiÃ³n de Documentos:**
  - Carga de cotizaciones, contratos, facturas, reservas
  - IDs Ãºnicos para cada documento
  - CategorizaciÃ³n por tipo de documento
  - Almacenamiento seguro en servidor
- **Sistema de Notificaciones:**
  - Alertas de asignaciÃ³n de prospectos
  - Recordatorios de seguimiento
  - Notificaciones de inactividad
  - Panel de notificaciones con filtros avanzados
  - CreaciÃ³n manual de notificaciones personalizadas

### ğŸ”” Panel de Notificaciones Avanzado
- **Filtros MÃºltiples:**
  - Por tipo (asignaciÃ³n, seguimiento, inactividad)
  - Por estado (leÃ­das/no leÃ­das)
  - Por rango de fechas
- **BÃºsqueda Inteligente:**
  - Por ID de cliente
  - Por ID de cotizaciÃ³n
  - Por nombre de prospecto
- **CreaciÃ³n Manual de Notificaciones:**
  - Asociadas a prospectos especÃ­ficos
  - ProgramaciÃ³n de recordatorios futuros
  - Registro automÃ¡tico en historial de interacciones

### ğŸ›¡ï¸ Roles y Seguridad
- **Administrador/Supervisor:** 
  - Acceso total a mÃ©tricas y estadÃ­sticas globales
  - ReasignaciÃ³n de leads
  - GestiÃ³n de usuarios (activos/inactivos)
  - ImportaciÃ³n masiva de datos
  - VisualizaciÃ³n de todos los prospectos
- **Agente:** 
  - Vista enfocada en prospectos asignados
  - EstadÃ­sticas personales
  - Herramientas de venta diaria
  - GestiÃ³n de seguimiento y documentos

### ğŸ‘¤ GestiÃ³n de Usuarios
- **Usuarios Activos e Inactivos:**
  - Marcado de usuarios como inactivos
  - ReasignaciÃ³n automÃ¡tica de prospectos a "Servicio al Cliente"
  - ExclusiÃ³n de usuarios inactivos en estadÃ­sticas
  - Indicadores visuales en la interfaz
- **ImportaciÃ³n desde Excel:**
  - ActualizaciÃ³n masiva de usuarios
  - DetecciÃ³n automÃ¡tica de usuarios inactivos
  - GeneraciÃ³n de contraseÃ±as aleatorias

### ğŸ“¥ ImportaciÃ³n de Datos
- **ImportaciÃ³n de Usuarios:**
  - Plantilla Excel predefinida
  - ValidaciÃ³n de datos
  - Manejo de usuarios existentes
  - GestiÃ³n de usuarios inactivos
- **ImportaciÃ³n de Prospectos:**
  - Plantilla Excel con todos los campos
  - DetecciÃ³n de clientes recurrentes
  - NormalizaciÃ³n automÃ¡tica de datos
  - ValidaciÃ³n de telÃ©fonos y emails
  - AsignaciÃ³n automÃ¡tica de agentes

### ğŸ” BÃºsqueda y Filtros Avanzados
- **Panel de Prospectos:**
  - Filtros por estado, destino, agente, medio de ingreso
  - BÃºsqueda global por nombre, telÃ©fono, email
  - Filtros de fecha (rango personalizado)
  - PaginaciÃ³n configurable
  - ExportaciÃ³n de resultados
- **Identificadores Ãšnicos:**
  - ID de Cliente (CL-YYYYMMDD-XXXX)
  - ID de Documento (DOC-YYYYMMDD-XXXX)
  - ID de CotizaciÃ³n (COT-YYYYMMDD-XXXX)

### ğŸ—‘ï¸ Soft Delete
- **EliminaciÃ³n LÃ³gica:**
  - Los prospectos no se eliminan fÃ­sicamente
  - Fecha de eliminaciÃ³n registrada
  - Posibilidad de recuperaciÃ³n
  - ExclusiÃ³n automÃ¡tica de consultas normales

---

## ğŸ› ï¸ TecnologÃ­as Utilizadas

- **Backend:** Python 3.9+ con [FastAPI](https://fastapi.tiangolo.com/)
- **Base de Datos:** PostgreSQL con SQLAlchemy ORM
- **Frontend:** HTML5, Jinja2 Templates, Bootstrap 5, JavaScript
- **Servidor:** Uvicorn (ASGI)
- **Procesamiento de Datos:** Pandas, OpenPyXL
- **AutenticaciÃ³n:** Passlib, BCrypt, Python-JOSE
- **Variables de Entorno:** Python-dotenv

---

## ğŸ”§ InstalaciÃ³n y ConfiguraciÃ³n

### Requisitos Previos
- Python 3.9 o superior
- PostgreSQL 12 o superior
- pip (gestor de paquetes de Python)

### 1. Clonar el Repositorio
```bash
git clone https://github.com/tu-usuario/prospectos_app.git
cd prospectos_app
```

### 2. Crear Entorno Virtual (Recomendado)
```bash
# En Windows
python -m venv venv
.\venv\Scripts\activate

# En macOS/Linux
python3 -m venv venv
source venv/bin/activate
```

### 3. Instalar Dependencias
```bash
pip install -r requirements.txt
```

### 4. Configurar Base de Datos

#### OpciÃ³n A: Usar PostgreSQL (Recomendado para producciÃ³n)
1. Crear base de datos PostgreSQL:
```bash
python crear_db_postgres.py
```

2. Configurar archivo `.env`:
```env
DATABASE_URL=postgresql://usuario:contraseÃ±a@localhost/prospectos_db
```

#### OpciÃ³n B: Usar SQLite (Para desarrollo)
El sistema crearÃ¡ automÃ¡ticamente `prospectos.db` si no existe configuraciÃ³n de PostgreSQL.

### 5. Inicializar Datos
En el primer inicio, el sistema crearÃ¡ automÃ¡ticamente:
- **Usuario Administrador:** `admin` / `admin123`
- **Usuario Agente de Prueba:** `agente1` / `agente123`
- **Usuario Servicio al Cliente:** `servicio_cliente` / `servicio123`
- **Medios de Ingreso:** REDES, TEL TRAVEL, RECOMPRA, REFERIDO, FIDELIZACION

> **âš ï¸ IMPORTANTE:** Cambia la contraseÃ±a del administrador despuÃ©s del primer inicio.

### 6. Ejecutar la AplicaciÃ³n
```bash
uvicorn main:app --reload
```

La aplicaciÃ³n estarÃ¡ disponible en: `http://127.0.0.1:8000`

Para producciÃ³n (sin reload):
```bash
uvicorn main:app --host 0.0.0.0 --port 8000
```

---

## ğŸ“– GuÃ­a de Uso

### Para Administradores

#### 1. Primer Inicio
1. Accede a `http://127.0.0.1:8000`
2. Inicia sesiÃ³n con `admin` / `admin123`
3. Cambia tu contraseÃ±a en el perfil

#### 2. Importar Usuarios
1. Ve a **"Importar Datos"** en el menÃº
2. Descarga la plantilla de usuarios
3. Completa la plantilla con los datos de tus agentes
4. Sube el archivo Excel
5. Revisa el resumen de importaciÃ³n

**Campos de la plantilla de usuarios:**
- `username`: Nombre de usuario Ãºnico
- `email`: Correo electrÃ³nico
- `password`: ContraseÃ±a (se encriptarÃ¡ automÃ¡ticamente)
- `tipo_usuario`: administrador, supervisor, o agente
- `activo`: 1 (activo) o 0 (inactivo)

#### 3. Importar Prospectos
1. Ve a **"Importar Datos"** en el menÃº
2. Descarga la plantilla de prospectos
3. Completa la plantilla con los datos
4. Sube el archivo Excel
5. Revisa el resumen (exitosos, errores, recurrentes)

**Campos principales de la plantilla de prospectos:**
- InformaciÃ³n bÃ¡sica: nombre, apellido, telÃ©fono, email
- Detalles del viaje: origen, destino, fechas, pasajeros
- AsignaciÃ³n: agente_asignado, medio_ingreso
- Estado: nuevo, en_seguimiento, cotizado, ganado, cerrado_perdido

#### 4. Gestionar Usuarios Inactivos
1. Importa usuarios con `activo = 0`
2. El sistema automÃ¡ticamente:
   - Reasigna sus prospectos a "Servicio al Cliente"
   - Los excluye de estadÃ­sticas
   - Mantiene su historial intacto

### Para Agentes

#### 1. Dashboard Personal
- Visualiza tus estadÃ­sticas personales
- Filtra por periodo (hoy, semana, mes, aÃ±o)
- Revisa tus KPIs de conversiÃ³n

#### 2. GestiÃ³n de Prospectos
1. **Crear Nuevo Prospecto:**
   - Clic en "â• Nuevo Prospecto"
   - Completa el formulario
   - Guarda

2. **Ver Detalle:**
   - Clic en "ğŸ“‹" en la lista
   - Revisa informaciÃ³n completa
   - Accede a historial e interacciones

3. **Registrar Seguimiento:**
   - En el detalle del prospecto
   - Clic en "Agregar InteracciÃ³n"
   - Selecciona tipo y describe la interacciÃ³n

4. **Cambiar Estado:**
   - En el detalle del prospecto
   - Selecciona nuevo estado
   - Agrega comentario (opcional)
   - Guarda

5. **Subir Documentos:**
   - En el detalle del prospecto
   - Clic en "Subir Documento"
   - Selecciona tipo y archivo
   - Agrega descripciÃ³n

#### 3. Notificaciones
1. Clic en el Ã­cono de campana ğŸ””
2. Revisa notificaciones pendientes
3. Filtra por tipo o estado
4. Marca como leÃ­das
5. Crea notificaciones manuales para recordatorios

#### 4. Contacto con Clientes
- Usa los botones de WhatsApp para contacto directo
- Los enlaces se generan automÃ¡ticamente con el indicativo correcto

---

## ğŸ“‚ Estructura del Proyecto

```text
prospectos_app/
â”œâ”€â”€ main.py                                    # AplicaciÃ³n principal FastAPI
â”œâ”€â”€ models.py                                  # Modelos de base de datos (SQLAlchemy)
â”œâ”€â”€ database.py                                # ConfiguraciÃ³n de conexiÃ³n a BD
â”œâ”€â”€ auth.py                                    # LÃ³gica de autenticaciÃ³n y hashing
â”œâ”€â”€ excel_import.py                            # LÃ³gica de importaciÃ³n desde Excel
â”œâ”€â”€ requirements.txt                           # Dependencias del proyecto
â”œâ”€â”€ .env                                       # Variables de entorno (no en git)
â”œâ”€â”€ .gitignore                                 # Archivos ignorados por git
â”‚
â”œâ”€â”€ templates/                                 # Plantillas HTML (Jinja2)
â”‚   â”œâ”€â”€ base.html                              # Layout principal
â”‚   â”œâ”€â”€ login.html                             # PÃ¡gina de inicio de sesiÃ³n
â”‚   â”œâ”€â”€ dashboard.html                         # Panel de control
â”‚   â”œâ”€â”€ prospectos.html                        # Lista de prospectos
â”‚   â”œâ”€â”€ prospecto_detalle.html                 # Detalle de prospecto
â”‚   â”œâ”€â”€ prospecto_form.html                    # Formulario de prospecto
â”‚   â”œâ”€â”€ notificaciones.html                    # Panel de notificaciones
â”‚   â”œâ”€â”€ importar_datos.html                    # ImportaciÃ³n de datos
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ static/                                    # Archivos estÃ¡ticos
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ styles.css                         # Estilos personalizados
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â””â”€â”€ scripts.js                         # Scripts JavaScript
â”‚   â”œâ”€â”€ img/                                   # ImÃ¡genes
â”‚   â””â”€â”€ plantillas/                            # Plantillas Excel
â”‚       â”œâ”€â”€ plantilla_usuarios.xlsx
â”‚       â””â”€â”€ plantilla_prospectos.xlsx
â”‚
â”œâ”€â”€ uploads/                                   # Documentos subidos (no en git)
â”‚
â”œâ”€â”€ scripts de migraciÃ³n/                      # Scripts de utilidad
â”‚   â”œâ”€â”€ crear_db_postgres.py                   # Crear BD PostgreSQL
â”‚   â”œâ”€â”€ borrar_bd_postgres.py                  # Eliminar BD PostgreSQL
â”‚   â”œâ”€â”€ migrar_datos_sqlite_postgres.py        # Migrar de SQLite a PostgreSQL
â”‚   â”œâ”€â”€ generar_plantilla.py                   # Generar plantillas Excel
â”‚   â”œâ”€â”€ actualizar_plantilla_prospectos.py     # Actualizar plantilla
â”‚   â”œâ”€â”€ actualizar_plantilla_usuarios.py       # Actualizar plantilla
â”‚   â”œâ”€â”€ verificar_usuarios_inactivos.py        # Verificar usuarios inactivos
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ prospectos.db                              # Base de datos SQLite (desarrollo)
```

---

## ğŸ—„ï¸ Estructura de Base de Datos

### Tablas Principales

#### `usuarios`
- `id`: ID Ãºnico
- `username`: Nombre de usuario (Ãºnico)
- `email`: Correo electrÃ³nico
- `hashed_password`: ContraseÃ±a encriptada
- `tipo_usuario`: administrador, supervisor, agente
- `activo`: 1 (activo) o 0 (inactivo)
- `fecha_creacion`: Fecha de creaciÃ³n

#### `prospectos`
- `id`: ID Ãºnico
- `id_cliente`: ID de cliente (CL-YYYYMMDD-XXXX)
- `nombre`, `apellido`: InformaciÃ³n bÃ¡sica
- `correo_electronico`, `telefono`, `telefono_secundario`: Contacto
- `indicativo_telefono`, `indicativo_telefono_secundario`: CÃ³digos de paÃ­s
- `ciudad_origen`, `destino`: InformaciÃ³n de viaje
- `fecha_ida`, `fecha_vuelta`: Fechas de viaje
- `pasajeros_adultos`, `pasajeros_ninos`, `pasajeros_infantes`: Pasajeros
- `medio_ingreso_id`: CÃ³mo llegÃ³ el prospecto
- `observaciones`: Notas adicionales
- `fecha_registro`: Fecha de creaciÃ³n
- `agente_asignado_id`: Agente actual
- `agente_original_id`: Primer agente asignado
- `estado`: Estado actual del prospecto
- `tiene_datos_completos`: Boolean
- `cliente_recurrente`: Boolean
- `prospecto_original_id`: Referencia a prospecto original
- `fecha_nacimiento`, `numero_identificacion`, `direccion`: Datos adicionales
- `fecha_compra`: Fecha de cierre de venta
- `fecha_eliminacion`: Soft delete

#### `interacciones`
- `id`: ID Ãºnico
- `prospecto_id`: Prospecto relacionado
- `usuario_id`: Usuario que registrÃ³
- `tipo_interaccion`: Tipo de interacciÃ³n
- `descripcion`: DescripciÃ³n detallada
- `fecha_creacion`: Fecha y hora
- `estado_anterior`, `estado_nuevo`: Cambios de estado

#### `documentos`
- `id`: ID Ãºnico
- `id_documento`: ID de documento (DOC-YYYYMMDD-XXXX)
- `prospecto_id`: Prospecto relacionado
- `usuario_id`: Usuario que subiÃ³
- `nombre_archivo`: Nombre del archivo
- `tipo_documento`: cotizacion, contrato, factura_proveedor, etc.
- `ruta_archivo`: Ruta en servidor
- `fecha_subida`: Fecha de carga
- `descripcion`: DescripciÃ³n

#### `notificaciones`
- `id`: ID Ãºnico
- `usuario_id`: Usuario destinatario
- `prospecto_id`: Prospecto relacionado
- `tipo`: asignacion, inactividad, seguimiento
- `mensaje`: Contenido de la notificaciÃ³n
- `fecha_creacion`: Fecha de creaciÃ³n
- `fecha_programada`: Fecha programada (recordatorios)
- `leida`: Boolean
- `email_enviado`: Boolean

#### `estadisticas_cotizacion`
- `id`: ID Ãºnico
- `id_cotizacion`: ID de cotizaciÃ³n (COT-YYYYMMDD-XXXX)
- `agente_id`: Agente que cotizÃ³
- `prospecto_id`: Prospecto cotizado
- `fecha_cotizacion`: Fecha de cotizaciÃ³n
- `fecha_registro`: Fecha de registro

#### `historial_estados`
- `id`: ID Ãºnico
- `prospecto_id`: Prospecto relacionado
- `estado_anterior`, `estado_nuevo`: TransiciÃ³n de estado
- `usuario_id`: Usuario que cambiÃ³
- `fecha_cambio`: Fecha del cambio
- `comentario`: Comentario opcional

#### `medios_ingreso`
- `id`: ID Ãºnico
- `nombre`: Nombre del medio (REDES, TEL TRAVEL, etc.)
- `activo`: 1 (activo) o 0 (inactivo)

---

## ğŸ” Seguridad

- **AutenticaciÃ³n:** Sistema de sesiones con tokens seguros
- **ContraseÃ±as:** EncriptaciÃ³n con BCrypt
- **Sesiones:** Timeout de 30 minutos
- **ValidaciÃ³n:** ValidaciÃ³n de datos en backend
- **SQL Injection:** ProtecciÃ³n mediante ORM SQLAlchemy
- **XSS:** Escape automÃ¡tico en templates Jinja2

---

## ğŸš€ Despliegue en ProducciÃ³n

### Consideraciones
1. **Base de Datos:** Usar PostgreSQL en lugar de SQLite
2. **Variables de Entorno:** Configurar `.env` con credenciales seguras
3. **HTTPS:** Usar certificados SSL/TLS
4. **Servidor:** Usar Nginx como proxy reverso
5. **Proceso:** Usar supervisor o systemd para mantener la aplicaciÃ³n corriendo

### Ejemplo de configuraciÃ³n Nginx
```nginx
server {
    listen 80;
    server_name tu-dominio.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## ğŸ“ Mantenimiento

### Backups
```bash
# PostgreSQL
pg_dump prospectos_db > backup_$(date +%Y%m%d).sql

# SQLite
cp prospectos.db backups/prospectos_$(date +%Y%m%d).db
```

### Logs
Los logs se imprimen en consola. Para producciÃ³n, redirigir a archivo:
```bash
uvicorn main:app --host 0.0.0.0 --port 8000 >> logs/app.log 2>&1
```

---

## ğŸ› SoluciÃ³n de Problemas

### Error de conexiÃ³n a base de datos
- Verifica que PostgreSQL estÃ© corriendo
- Revisa las credenciales en `.env`
- Verifica que la base de datos exista

### Error al importar Excel
- Verifica que el archivo tenga el formato correcto
- Revisa que las columnas coincidan con la plantilla
- Verifica que no haya caracteres especiales en los datos

### SesiÃ³n expirada
- Las sesiones expiran despuÃ©s de 30 minutos
- Vuelve a iniciar sesiÃ³n

---

## ğŸ“ Soporte

Para soporte tÃ©cnico o reportar problemas:
- Email: soporte@zarita.com
- DocumentaciÃ³n: [Wiki del proyecto]

---

## ğŸ“„ Licencia

Este proyecto es propiedad de **ZARITA! Travel Agency**.

---

## ğŸ‘¥ CrÃ©ditos

Desarrollado para **ZARITA! Travel Agency**  
VersiÃ³n: 2.0  
Ãšltima actualizaciÃ³n: Enero 2026
