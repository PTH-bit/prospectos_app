{% extends "base.html" %}

{% block title %}Notificaciones - ZARITA!{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-3 mb-3 border-bottom">
    <h1 class="h2 fw-bold text-primary">üîî Centro de Notificaciones</h1>

    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevaNotificacion">
        <i class="fas fa-plus"></i> Nueva Notificaci√≥n
    </button>
</div>

<!-- Mensajes de √©xito/error -->
{% if request.query_params.get('success') %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> {{ request.query_params.get('success') }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if request.query_params.get('error') %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-circle"></i> {{ request.query_params.get('error') }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- Formulario de Filtros -->
<div class="card mb-4 border-0 shadow-sm bg-light">
    <div class="card-body py-3">
        <form method="get" action="/notificaciones" class="row g-3">
            <!-- Filtro por Tipo -->
            <div class="col-md-2">
                <label class="form-label small fw-bold">Tipo</label>
                <select class="form-select form-select-sm" name="filtro_tipo">
                    <option value="todos" {% if not filtro_tipo or filtro_tipo=='todos' %}selected{% endif %}>Todos
                    </option>
                    <option value="seguimiento" {% if filtro_tipo=='seguimiento' %}selected{% endif %}>üîî Seguimiento
                    </option>
                    <option value="asignacion" {% if filtro_tipo=='asignacion' %}selected{% endif %}>üë§ Asignaci√≥n
                    </option>
                    <option value="inactividad" {% if filtro_tipo=='inactividad' %}selected{% endif %}>‚ö†Ô∏è Inactividad
                    </option>
                </select>
            </div>

            <!-- Filtro por Estado -->
            <div class="col-md-2">
                <label class="form-label small fw-bold">Estado</label>
                <select class="form-select form-select-sm" name="filtro_estado">
                    <option value="" {% if not filtro_estado %}selected{% endif %}>Pendientes</option>
                    <option value="leidas" {% if filtro_estado=='leidas' %}selected{% endif %}>‚úÖ Le√≠das</option>
                    <option value="vencidas" {% if filtro_estado=='vencidas' %}selected{% endif %}>üî¥ Vencidas</option>
                    <option value="proximas" {% if filtro_estado=='proximas' %}selected{% endif %}>üü¢ Pr√≥ximas</option>
                </select>
            </div>

            <!-- Filtro por Agente (solo admin/supervisor) -->
            {% if current_user.tipo_usuario in ['administrador', 'supervisor'] %}
            <div class="col-md-2">
                <label class="form-label small fw-bold">Agente</label>
                <select class="form-select form-select-sm" name="filtro_agente_id">
                    <option value="todos">Todos</option>
                    {% for agente in agentes %}
                    <option value="{{ agente.id }}" {% if filtro_agente_id==agente.id|string %}selected{% endif %}>
                        {{ agente.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <!-- Filtro por Fecha -->
            <div class="col-md-2">
                <label class="form-label small fw-bold">Desde</label>
                <input type="text" class="form-control form-control-sm date-picker-input" name="fecha_inicio"
                    value="{{ fecha_inicio or '' }}" placeholder="dd/mm/aaaa">
            </div>

            <div class="col-md-2">
                <label class="form-label small fw-bold">Hasta</label>
                <input type="text" class="form-control form-control-sm date-picker-input" name="fecha_fin"
                    value="{{ fecha_fin or '' }}" placeholder="dd/mm/aaaa">
            </div>

            <!-- L√≠mite de registros -->
            <div class="col-md-1">
                <label class="form-label small fw-bold">Por p√°gina</label>
                <select class="form-select form-select-sm" name="limit" onchange="this.form.submit()">
                    <option value="10" {% if limit==10 %}selected{% endif %}>10</option>
                    <option value="20" {% if limit==20 %}selected{% endif %}>20</option>
                    <option value="50" {% if limit==50 %}selected{% endif %}>50</option>
                    <option value="100" {% if limit==100 %}selected{% endif %}>100</option>
                </select>
            </div>

            <!-- Botones -->
            <div class="col-md-2 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary btn-sm flex-fill">
                    <i class="fas fa-filter"></i> Filtrar
                </button>
                <a href="/notificaciones" class="btn btn-outline-secondary btn-sm" title="Limpiar filtros">
                    <i class="fas fa-times"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<!-- KPIs R√°pidos -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-primary text-white">
            <div class="card-body p-3 d-flex align-items-center">
                <div class="icon-shape bg-white text-primary rounded-circle me-3">
                    <i class="fas fa-bell"></i>
                </div>
                <div>
                    <h3 class="mb-0 fw-bold">{{ notificaciones|length }}</h3>
                    <small class="text-white-50">de {{ total_notificaciones }}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-header bg-white py-3">
        <h5 class="card-title mb-0">Alertas Recientes</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">Tipo</th>
                        <th>Mensaje / Prospecto</th>
                        <th>Agente</th>
                        <th>Tiempo</th>
                        <th class="text-end pe-4">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    {% if notificaciones %}
                    {% for notif in notificaciones %}
                    <tr class="{% if notif.leida %}bg-light opacity-75{% endif %}">
                        <td class="ps-4">
                            {% if notif.tipo == 'asignacion' %}
                            <div class="icon-shape icon-sm bg-soft-primary text-primary rounded-circle">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            {% elif notif.tipo == 'inactividad' %}
                            <div class="icon-shape icon-sm bg-soft-danger text-danger rounded-circle">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            {% elif notif.tipo == 'seguimiento' %}
                            <div class="icon-shape icon-sm bg-soft-warning text-warning rounded-circle">
                                <i class="fas fa-clock"></i>
                            </div>
                            {% else %}
                            <div class="icon-shape icon-sm bg-soft-secondary text-secondary rounded-circle">
                                <i class="fas fa-info"></i>
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="fw-bold">{{ notif.mensaje }}</div>
                            {% if notif.prospecto %}
                            <a href="/prospectos/{{ notif.prospecto.id }}/seguimiento"
                                class="small text-decoration-none">
                                Ver Prospecto: {{ notif.prospecto.nombre }} {{ notif.prospecto.apellido }}
                            </a>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border">
                                <i class="fas fa-user-circle me-1"></i> {{ notif.usuario.username }}
                            </span>
                        </td>
                        <td>
                            {% if notif.tipo == 'seguimiento' and notif.fecha_programada %}
                            <span
                                class="badge {% if notif.es_tarde %}bg-soft-danger text-danger{% else %}bg-soft-success text-success{% endif %}">
                                <i class="fas fa-stopwatch me-1"></i> {{ notif.tiempo_restante_str }}
                            </span>
                            <div class="small text-muted mt-1">{{ notif.fecha_programada.strftime('%d/%m %H:%M') }}
                            </div>
                            {% else %}
                            <span class="text-muted small">{{ notif.tiempo_restante_str }}</span>
                            {% endif %}
                        </td>
                        <td class="text-end pe-4">
                            <form action="/notificaciones/{{ notif.id }}/leer" method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-secondary rounded-circle"
                                    title="Marcar como le√≠da">
                                    <i class="fas fa-check"></i>
                                </button>
                            </form>
                            {% if notif.prospecto %}
                            <a href="/prospectos/{{ notif.prospecto.id }}/seguimiento"
                                class="btn btn-sm btn-outline-primary rounded-circle ms-1" title="Gestionar">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="far fa-bell-slash fa-2x mb-3"></i>
                            <p>No tienes notificaciones pendientes.</p>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Paginaci√≥n -->
        {% if total_pages > 1 %}
        <div class="p-3 border-top">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                        <a class="page-link"
                            href="/notificaciones?page={{ page-1 }}&limit={{ limit }}&filtro_tipo={{ filtro_tipo or '' }}&filtro_estado={{ filtro_estado or '' }}&filtro_agente_id={{ filtro_agente_id or '' }}&fecha_inicio={{ fecha_inicio or '' }}&fecha_fin={{ fecha_fin or '' }}">Anterior</a>
                    </li>

                    <li class="page-item disabled">
                        <span class="page-link">P√°gina {{ page }} de {{ total_pages }}</span>
                    </li>

                    <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                        <a class="page-link"
                            href="/notificaciones?page={{ page+1 }}&limit={{ limit }}&filtro_tipo={{ filtro_tipo or '' }}&filtro_estado={{ filtro_estado or '' }}&filtro_agente_id={{ filtro_agente_id or '' }}&fecha_inicio={{ fecha_inicio or '' }}&fecha_fin={{ fecha_fin or '' }}">Siguiente</a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal: Nueva Notificaci√≥n -->
<div class="modal fade" id="modalNuevaNotificacion" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìù Crear Notificaci√≥n/Recordatorio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/notificaciones/crear" method="post">
                <div class="modal-body">
                    <!-- Mensaje -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Mensaje *</label>
                        <textarea class="form-control" name="mensaje" rows="3"
                            placeholder="Ej: Llamar a cliente para confirmar reserva" required></textarea>
                    </div>

                    <!-- Fecha y Hora -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Fecha y Hora del Recordatorio *</label>
                        <input type="datetime-local" class="form-control" name="fecha_programada" required>
                        <small class="text-muted">
                            Recibir√°s un popup autom√°tico cuando llegue esta fecha
                        </small>
                    </div>

                    <!-- B√∫squeda por ID -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Buscar Prospecto por ID (Opcional)</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="buscarPorId"
                                placeholder="CL-... (Cliente), SOL-... (Solicitud) o COT-... (Cotizaci√≥n)">
                            <button type="button" class="btn btn-outline-primary" onclick="buscarProspectoPorId()">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                        <small class="text-muted">
                            Busca por ID de Cliente, ID de Solicitud o ID de Cotizaci√≥n
                        </small>
                    </div>

                    <!-- Resultado de b√∫squeda -->
                    <div id="resultadoBusqueda" class="mb-3" style="display: none;">
                        <div class="alert alert-success">
                            <strong>‚úì Prospecto encontrado:</strong>
                            <div id="infoProspecto"></div>
                        </div>
                    </div>

                    <!-- Prospecto (Opcional) - Ahora oculto, se llena con b√∫squeda -->
                    <input type="hidden" name="prospecto_id" id="prospecto_id_hidden">

                    <!-- O seleccionar de lista -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">O seleccionar de la lista</label>
                        <select class="form-select" id="prospecto_select"
                            onchange="seleccionarProspectoLista(this.value)">
                            <option value="">Sin prospecto espec√≠fico</option>
                            {% for prospecto in prospectos_activos %}
                            <option value="{{ prospecto.id }}"
                                data-nombre="{{ prospecto.nombre }} {{ prospecto.apellido or '' }}"
                                data-destino="{{ prospecto.destino or '' }}">
                                {{ prospecto.id_solicitud or prospecto.id_cliente or 'Sin ID' }} -
                                {{ prospecto.nombre }} {{ prospecto.apellido or '' }} -
                                {{ prospecto.destino or '' }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-bell"></i> Crear Recordatorio
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .icon-shape.icon-sm {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
    }
</style>

<script>
    async function buscarProspectoPorId() {
        const idBusqueda = document.getElementById('buscarPorId').value.trim();
        if (!idBusqueda) {
            alert('Por favor ingresa un ID');
            return;
        }

        try {
            const response = await fetch(`/api/buscar-prospecto-por-id?id=${encodeURIComponent(idBusqueda)}`);
            const data = await response.json();

            if (data.success && data.prospecto) {
                // Mostrar resultado
                document.getElementById('infoProspecto').innerHTML = `
                <strong>${data.prospecto.id_cliente}</strong><br>
                ${data.prospecto.nombre} ${data.prospecto.apellido}<br>
                Destino: ${data.prospecto.destino || 'N/A'}
            `;
                document.getElementById('resultadoBusqueda').style.display = 'block';
                document.getElementById('prospecto_id_hidden').value = data.prospecto.id;

                // Limpiar select
                document.getElementById('prospecto_select').value = '';
            } else {
                alert('No se encontr√≥ ning√∫n prospecto con ese ID');
                document.getElementById('resultadoBusqueda').style.display = 'none';
            }
        } catch (error) {
            console.error('Error buscando prospecto:', error);
            alert('Error al buscar prospecto');
        }
    }

    function seleccionarProspectoLista(prospectoId) {
        if (prospectoId) {
            const select = document.getElementById('prospecto_select');
            const option = select.options[select.selectedIndex];

            document.getElementById('infoProspecto').innerHTML = `
            <strong>${option.text.split(' - ')[0]}</strong><br>
            ${option.dataset.nombre}<br>
            Destino: ${option.dataset.destino || 'N/A'}
        `;
            document.getElementById('resultadoBusqueda').style.display = 'block';
            document.getElementById('prospecto_id_hidden').value = prospectoId;

            // Limpiar campo de b√∫squeda
            document.getElementById('buscarPorId').value = '';
        } else {
            document.getElementById('resultadoBusqueda').style.display = 'none';
            document.getElementById('prospecto_id_hidden').value = '';
        }
    }
</script>
{% endblock %}