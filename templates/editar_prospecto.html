{% extends "base.html" %}

{% block title %}Editar Prospecto - Sistema de Prospectos{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">Editar Prospecto</h1>
            <a href="/prospectos" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver a la lista
            </a>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">Información del Prospecto #{{ prospecto.id }}</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/prospectos/{{ prospecto.id }}/editar">

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Los campos marcados con asterisco (*) son obligatorios.
                    </div>

                    <!-- Datos Personales -->
                    <h6 class="border-bottom pb-2 mb-3 text-muted">Datos Personales</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre</label>
                            <input type="text" class="form-control" name="nombre" value="{{ prospecto.nombre or '' }}"
                                data-uppercase>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Apellido</label>
                            <input type="text" class="form-control" name="apellido"
                                value="{{ prospecto.apellido or '' }}" data-uppercase>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Correo Electrónico</label>
                            <input type="email" class="form-control" name="correo_electronico"
                                value="{{ prospecto.correo_electronico or '' }}">
                        </div>
                    </div>

                    <!-- Información de Contacto -->
                    <h6 class="border-bottom pb-2 mb-3 mt-4 text-muted">Información de Contacto</h6>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Indicativo Principal *</label>
                            <div class="input-group">
                                <span class="input-group-text">+</span>
                                <input type="text" class="form-control" name="indicativo_telefono"
                                    value="{{ prospecto.indicativo_telefono or '57' }}" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Teléfono Principal *</label>
                            <input type="tel" class="form-control" name="telefono"
                                value="{{ prospecto.telefono or '' }}" required data-numeric>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Indicativo Secundario</label>
                            <div class="input-group">
                                <span class="input-group-text">+</span>
                                <input type="text" class="form-control" name="indicativo_telefono_secundario"
                                    value="{{ prospecto.indicativo_telefono_secundario or '57' }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Teléfono Secundario</label>
                            <input type="tel" class="form-control" name="telefono_secundario"
                                value="{{ prospecto.telefono_secundario or '' }}" data-numeric>
                        </div>
                    </div>

                    <!-- Datos del Viaje -->
                    <h6 class="border-bottom pb-2 mb-3 mt-4 text-muted">Datos del Viaje</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Ciudad de Origen</label>
                            <input type="text" class="form-control" name="ciudad_origen"
                                value="{{ prospecto.ciudad_origen or '' }}" data-uppercase>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Destino</label>
                            <input type="text" class="form-control" name="destino" value="{{ prospecto.destino or '' }}"
                                data-uppercase>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Fecha Ida</label>
                            <input type="text" class="form-control datepicker" name="fecha_ida"
                                value="{% if prospecto.fecha_ida %}{{ prospecto.fecha_ida.strftime('%d/%m/%Y') }}{% endif %}"
                                placeholder="dd/mm/aaaa">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha Vuelta</label>
                            <input type="text" class="form-control datepicker" name="fecha_vuelta"
                                value="{% if prospecto.fecha_vuelta %}{{ prospecto.fecha_vuelta.strftime('%d/%m/%Y') }}{% endif %}"
                                placeholder="dd/mm/aaaa">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Adultos</label>
                            <input type="number" class="form-control" name="pasajeros_adultos"
                                value="{{ prospecto.pasajeros_adultos }}" min="1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Niños</label>
                            <input type="number" class="form-control" name="pasajeros_ninos"
                                value="{{ prospecto.pasajeros_ninos }}" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Infantes</label>
                            <input type="number" class="form-control" name="pasajeros_infantes"
                                value="{{ prospecto.pasajeros_infantes }}" min="0">
                        </div>
                    </div>

                    <!-- Datos Adicionales -->
                    <h6 class="border-bottom pb-2 mb-3 mt-4 text-muted">Datos Adicionales</h6>
                    <div class="mb-3">
                        <label class="form-label">Medio de Ingreso *</label>
                        <select class="form-select" name="medio_ingreso_id" required>
                            <option value="">Seleccionar medio...</option>
                            {% for medio in medios_ingreso %}
                            <option value="{{ medio.id }}" {% if prospecto.medio_ingreso_id==medio.id %}selected{% endif
                                %}>
                                {{ medio.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Estado</label>
                        <select class="form-select" name="estado" id="estado">
                            <option value="nuevo" {% if prospecto.estado=='nuevo' %}selected{% endif %}>Nuevo</option>
                            <option value="en_seguimiento" {% if prospecto.estado=='en_seguimiento' %}selected{% endif
                                %}>En Seguimiento</option>
                            <option value="cotizado" {% if prospecto.estado=='cotizado' %}selected{% endif %}>Cotizado
                            </option>
                            <option value="ganado" {% if prospecto.estado=='ganado' %}selected{% endif %}>Ganado
                            </option>
                            <option value="cerrado_perdido" {% if prospecto.estado=='cerrado_perdido' %}selected{% endif
                                %}>Perdido</option>
                            {% if prospecto.estado == 'ganado' or prospecto.estado_anterior == 'ganado' or
                            prospecto.estado == 'venta_cancelada' %}
                            <option value="venta_cancelada" {% if prospecto.estado=='venta_cancelada' %}selected{% endif
                                %}>Venta Cancelada</option>
                            {% endif %}
                        </select>
                        <div class="form-text">
                            {% if prospecto.estado == 'ganado' or prospecto.estado_anterior == 'ganado' %}
                            <i class="fas fa-info-circle"></i> La opción "Venta Cancelada" está disponible porque este
                            prospecto fue GANADO.
                            {% endif %}
                        </div>
                    </div>

                    <!-- Campos adicionales para clientes GANADOS -->
                    <div id="campos-cliente-ganado"
                        style="display: {% if prospecto.estado == 'ganado' or prospecto.estado == 'venta_cancelada' or prospecto.estado_anterior == 'ganado' %}block{% else %}none{% endif %};">
                        <div class="alert alert-success">
                            <i class="fas fa-star"></i> <strong>Cliente Ganado</strong> - Puedes registrar información
                            adicional del cliente
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Fecha de Nacimiento (Opcional)</label>
                                <input type="date" class="form-control" name="fecha_nacimiento"
                                    value="{% if prospecto.fecha_nacimiento %}{{ prospecto.fecha_nacimiento.strftime('%Y-%m-%d') }}{% endif %}">
                                <div class="form-text">Información para personalización de servicios</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Número de Identificación (Opcional)</label>
                                <input type="text" class="form-control" name="numero_identificacion"
                                    value="{{ prospecto.numero_identificacion or '' }}" maxlength="50"
                                    placeholder="Cédula, Pasaporte, etc." data-numeric>
                                <div class="form-text">Documento de identidad del cliente</div>
                            </div>
                        </div>

                        <!-- ✅ NUEVO: Campo Dirección -->
                        <div class="mb-3">
                            <label class="form-label">Dirección (Opcional)</label>
                            <input type="text" class="form-control" name="direccion"
                                value="{{ prospecto.direccion or '' }}" maxlength="255"
                                placeholder="Dirección completa del cliente" data-uppercase>
                            <div class="form-text">Dirección de residencia o envío</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" name="observaciones"
                            rows="4">{{ prospecto.observaciones or '' }}</textarea>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="/prospectos" class="btn btn-secondary me-md-2">Cancelar</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        flatpickr(".datepicker", {
            dateFormat: "d/m/Y",
            locale: "es",
            allowInput: true
        });

        // ✅ VALIDACIÓN EN TIEMPO REAL: Auto-uppercase para campos de texto
        document.querySelectorAll('input[data-uppercase]').forEach(input => {
            input.addEventListener('input', function (e) {
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.toUpperCase();
                this.setSelectionRange(start, end);
            });
        });

        // ✅ VALIDACIÓN EN TIEMPO REAL: Solo números para campos numéricos
        document.querySelectorAll('input[data-numeric]').forEach(input => {
            input.addEventListener('input', function (e) {
                this.value = this.value.replace(/[^0-9]/g, '');
            });
        });

        // Mostrar/ocultar campos de cliente ganado según estado
        const estadoSelect = document.getElementById('estado');
        const camposClienteGanado = document.getElementById('campos-cliente-ganado');

        if (estadoSelect && camposClienteGanado) {
            estadoSelect.addEventListener('change', function () {
                if (this.value === 'ganado' || this.value === 'venta_cancelada') {
                    camposClienteGanado.style.display = 'block';
                } else {
                    camposClienteGanado.style.display = 'none';
                }
            });
        }
    });
</script>
{% endblock %}